name: Update Database

concurrency:
  group: db
  cancel-in-progress: false

on:
  workflow_dispatch:
  schedule:
    - cron: "30 3 * * *"

jobs:
  pull_db:
    name: 'Pull Updated Data'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout files
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Install s3cmd
        run: |
          sudo apt-get update
          sudo apt-get install -y s3cmd

      - name: Configure s3cmd for DO Spaces
        run: |
          cat > ~/.s3cfg <<EOF
          [default]
          access_key = ${{ secrets.DO_SPACES_ACCESS_KEY_ID }}
          secret_key = ${{ secrets.DO_SPACES_SECRET_ACCESS_KEY }}
          host_base = ${{ secrets.DO_SPACES_ENDPOINT }}
          host_bucket = %(bucket)s.${{ secrets.DO_SPACES_ENDPOINT }}
          use_https = True
          EOF

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "24"

      - name: Setup pnpm
        run: corepack enable && corepack prepare pnpm@latest --activate

      - name: Install Node Dependencies
        run: pnpm install --frozen-lockfile

      - name: Pull Latest DB
        run: s3cmd get s3://edhtop16/edhtop16.db

      - name: Run Database Migrations
        run: pnpm run migrate
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Generate Application Database
        run: pnpm run generate:db
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          TOPDECK_GG_API_KEY: ${{ secrets.TOPDECK_GG_API_KEY }}
          PROFILE_DATABASE_URL: ${{ secrets.PROFILE_DATABASE_URL }}
          PROFILE_DATABASE_CA_CERT: ${{ secrets.PROFILE_DATABASE_CA_CERT }}

      - name: Push Updated DB
        run: s3cmd put edhtop16.db s3://edhtop16

      - name: Create Timestamped Backup
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d_%H%M%S")
          s3cmd put edhtop16.db s3://edhtop16/backups/edhtop16_v2_${TIMESTAMP}.db

      - name: Deploy Application
        run: doctl apps create-deployment ${{ secrets.DIGITALOCEAN_APP_ID }} --force-rebuild --wait
